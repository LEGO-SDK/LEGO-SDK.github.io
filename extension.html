<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>扩展开发 - LEGO SDK</title>
    <meta name="description" content="LEGO SDK 是一个轻量的 WebView 增强组件，借助 SDK，只需几行代码，即可集成数十种原生API。">
    <meta name="keywords" content="WebView,SDK,LEGO,API,iOS,Android,UIWebView,WKWebView">
    <meta name="author" content="YY Inc. UED">
    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="//cdn.bootcss.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <link rel="stylesheet" href="//cdn.bootcss.com/highlight.js/8.4/styles/monokai_sublime.min.css">
    <!-- Custom styles for this template -->
    <link rel="stylesheet" href="assets/style.css">
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="//cdn.bootcss.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="//cdn.bootcss.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body>

    <nav class="navbar navbar-inverse navbar-fixed-top site-navbar">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false"
                    aria-controls="navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="index.html">LEGO SDK</a>
            </div>
            <div id="navbar" class="collapse navbar-collapse">
                <ul class="nav navbar-nav">
                    <li><a href="index.html">首页</a>
                    </li>
                    <li><a href="intergrade.html">集成</a>
                    </li>
                    <li><a href="guide.html">入门指南</a>
                    </li>
                    <li><a href="docs/api/">API</a>
                    </li>
                    <li><a href="extension.html">扩展开发</a>
                    </li>
                    <li><a>常见问题</a>
                    </li>
                </ul>
            </div>
            <!--/.nav-collapse -->
        </div>
    </nav>



    <main class="docs-wrapper container">
        <div class="row">
            <article class="col-md-8 col-md-push-2 markdown-body" id="docs-content">
                <h1>扩展开发</h1>
                如果 SDK 提供的官方 API 未能满足你的需要，你可以自行扩展 API。<br/> 对 SDK 进行扩展十分简单，我们将以一个简单的 <span class="text-info">UED.Test</span>                API 作演示。

                <h2>SDK 基类</h2>

                <h3>LGOModule</h3>

                LGOModule 是 API 的入口类，所有的请求都会直接调用 LGOModule 中的 build 方法。 你需要重写 build 方法，并返回一个 LGORequestable 实例。

                <h3>LGORequest</h3>

                LGORequest 是请求类，任何请求都会被转换为 LGORequest 以承载相关的请求参数。

                <h3>LGORequestable</h3>

                LGORequestable 是执行请求的实例，所有的请求最终执行者都是 LGORequestable。<br/> 你需要重写 request 方法，同步或异步地返回 LGOResponse 实例。

                <h3>LGOResponse</h3>

                LGOResponse 是结果类，LGOResponse 会被转换为 JSON 数据返回至 WebView。

                <h2>时序</h2>

                <h3>1. JS 发起请求</h3>
                Javascript 发起一个请求至原生应用。

                <h3>2. LGOModule</h3>
                LGOModule 收到这个请求，并返回一个 LGORequestable 实例，同时赋予 LGORequestable 一个 LGORequest 对象作为成员变量。

                <h3>3. LGORequestable</h3>
                LGORequestable 中的 request 方法会被调用，LGORequestable 返回 LGOResponse 实例。

                <h3>4. LGOResponse</h3>
                LGOResponse 中的数据会被编码并返回至 Javascript 上下文，请求完成。

                <h2>iOS Sample</h2>

                先集成 SDK Core，具体集成方法参阅<a href="intergrade.html">集成</a><br/> 假定 Test API 接受一个参数 String name，返回一个参数 String text。<br/>假如
                Test API 接收到的参数不合法，则返回错误 invalid name。

                <h3>1. 创建相关文件</h3>
                New file -> 创建一个 NSObject 类，类继承 LGOModule。
                <pre><code class="language-objc">//
//  LGOTest.h

#import &lt;LEGO-SDK/LGOProtocols.h&gt;
#import &lt;LEGO-SDK/LGOProtocols.h&gt;

@interface LGOTest : LGOModule

@end</code></pre>

                <pre><code class="language-objc">//
//  LGOTest.m

#import "LGOTest.h"

@implementation LGOTest

@end</code></pre>

                <h3>2. 创建相关类</h3>

                按照请求参数、返回值等信息，创建相关类。

                <pre><code class="language-objc">//
//  LGOTest.m

#import "LGOTest.h"

@interface LGOTestRequest: LGORequest

@property (nonatomic, copy) NSString *name;

@end

@implementation LGOTestRequest

@end

@interface LGOTestResponse : LGOResponse

@property (nonatomic, copy) NSString *text;

@end

@implementation LGOTestResponse

- (NSDictionary *)resData {
    return @{
             @"text": self.text != nil ? self.text : [NSNull null]
             };
}

@end

@interface LGOTestOperation : LGORequestable

@end

@implementation LGOTestOperation

@end

@implementation LGOTest

@end</code></pre>

                <h3>3. 接收请求</h3>
                添加 LGORequest 属性至 LGOTestOperation 类。继续完善 LGOTest 类，重写 build 方法。并根据参数合法性，返回对应 LGORequestable。
                <pre><code class="language-objc">//
//  LGOTest.m

#import "LGOTest.h"

@interface LGOTestRequest: LGORequest

@property (nonatomic, copy) NSString *name;

@end

@implementation LGOTestRequest

@end

@interface LGOTestResponse : LGOResponse

@property (nonatomic, copy) NSString *text;

@end

@implementation LGOTestResponse

- (NSDictionary *)resData {
    return @{
             @"text": self.text != nil ? self.text : [NSNull null]
             };
}

@end

@interface LGOTestOperation : LGORequestable

@property (nonatomic, strong) LGOTestRequest *request;

@end

@implementation LGOTestOperation

@end

@implementation LGOTest

- (LGORequestable *)buildWithDictionary:(NSDictionary *)dictionary context:(LGORequestContext *)context {
    LGOTestRequest *reqeust = [[LGOTestRequest alloc] init];
    reqeust.name = [dictionary[@"name"] isKindOfClass:[NSString class]] ? dictionary[@"name"] : nil;
    if (reqeust.name == nil) {
        return [LGORequestable rejectWithDomain:@"Test" code:-1 reason:@"invalid name."];
    }
    LGOTestOperation *operation = [[LGOTestOperation alloc] init];
    operation.request = reqeust;
    return operation;
}

@end
</code></pre>

                <h3>4. 处理请求</h3>
                重写 LGOOperation 中的 request 方法，并返回 LGOTestResponse 实例。

                <pre><code class="language-objc">@implementation LGOTestOperation

- (LGOResponse *)requestSynchronize {
    LGOTestResponse *response = [[LGOTestResponse alloc] init];
    response.text = [NSString stringWithFormat:@"Hello, %@.", self.request.name];
    return [response accept:nil];
}

@end</code></pre>

                <h3>5. 添加模块至 Core 中</h3>
                在 LGOTest 的实现中，添加 load 方法，这样，应用启动时，Test API 就会附着到 SDK 中。

                <pre><code class="language-objc">+ (void)load {
    [[LGOCore modules] addModuleWithName:@"UED.Test" instance:[LGOTest new]];
}</code></pre>

                <h3>6. 测试</h3>
                在 WebView 中进行调用测试，具体测试过程不再叙述，可以下载 Sample Code 测试。<br/>
                <a href="https://github.com/LEGO-SDK/PluginSample-iOS">https://github.com/LEGO-SDK/PluginSample-iOS</a>

                <h2>Android Sample</h2>

                先集成 SDK Core，具体集成方法参阅<a href="intergrade.html">集成</a><br/> 假定 Test API 接受一个参数 String name，返回一个参数 String text。<br/>假如
                Test API 接收到的参数不合法，则返回错误 invalid name。

                <h3>1. 创建相关文件</h3>
                创建一个新的类 LGOTest.java 并继承 LGOModule。
                <pre><code class="language-java">package com.opensource.legosdk.pluginsample;

import com.lego.sdk.core.LGOModule;

public class LGOTest extends LGOModule {
}</code></pre>

                <h3>2. 创建相关类</h3>

                按照请求参数、返回值等信息，创建相关类。

                <pre><code class="language-java">package com.opensource.legosdk.pluginsample;

import com.lego.sdk.core.LGOModule;
import com.lego.sdk.core.LGORequest;
import com.lego.sdk.core.LGORequestable;
import com.lego.sdk.core.LGOResponse;

import org.json.JSONObject;

public class LGOTest extends LGOModule {
}

class LGOTestRequest extends LGORequest {

    String name;

}

class LGOTestResponse extends LGOResponse {

    String text;

    @Override
    public JSONObject resData() {
        JSONObject obj = new JSONObject();
        try {
            obj.put("text", text);
        } catch (Exception e) {}
        return obj;
    }

}

class LGOTestOperation extends LGORequestable {

}</code></pre>

                <h3>3. 接收请求</h3>
                添加 LGORequest 属性至 LGOTestOperation 类。继续完善 LGOTest 类，重写 build 方法。并根据参数合法性，返回对应 LGORequestable。

                <pre><code class="language-java">package com.opensource.legosdk.pluginsample;

import android.content.Context;

import com.lego.sdk.core.LGOModule;
import com.lego.sdk.core.LGORequest;
import com.lego.sdk.core.LGORequestable;
import com.lego.sdk.core.LGOResponse;

import org.json.JSONObject;

public class LGOTest extends LGOModule {

    @Override
    public LGORequestable build(JSONObject object, Context context) {
        LGOTestRequest request = new LGOTestRequest();
        try {
            request.name = object.getString("name");
        } catch (Exception e) {
            return LGORequestable.reject("Test", -1, "invalid name.");
        }
        LGOTestOperation operation = new LGOTestOperation();
        operation.request = request;
        return operation;
    }
}

class LGOTestRequest extends LGORequest {

    String name;

}

class LGOTestResponse extends LGOResponse {

    String text;

    @Override
    public JSONObject resData() {
        JSONObject obj = new JSONObject();
        try {
            obj.put("text", text);
        } catch (Exception e) {}
        return obj;
    }

}

class LGOTestOperation extends LGORequestable {

    LGOTestRequest request;

}</code></pre>

                <h3>4. 处理请求</h3>
                重写 LGOOperation 中的 request 方法，并返回 LGOTestResponse 实例。

                <pre><code class="language-java">class LGOTestOperation extends LGORequestable {

    LGOTestRequest request;

    @Override
    public LGOResponse requestSynchronize(LGOMessage message, Context context) {
        LGOTestResponse response = new LGOTestResponse();
        response.text = "Hello, " + request.name + ".";
        return response;
    }
    
}</code></pre>

                <h3>5. 添加模块至 Core 中</h3>
                在 LGORuntime.attach() 执行前，添加以下代码。
                <pre><code class="language-java">LGOCore.sharedCore().modules.put("UED.Test", new LGOTest());</code></pre>

                <h3>6. 测试</h3>
                在 WebView 中进行调用测试，具体测试过程不再叙述，可以下载 Sample Code 测试。<br/>
                <a href="https://github.com/LEGO-SDK/PluginSample-Android">https://github.com/LEGO-SDK/PluginSample-Android</a>

            </article>
        </div>

    </main>

    <!-- Site footer -->
    <footer class="footer">
        <div class="container">
            <p>LEGO SDK 使用 Apache License, Version 2.0 协议开源</p>
            <p>&copy; UED Team, YY Inc. 2016</p>
        </div>
    </footer>


    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="//cdn.bootcss.com/highlight.js/8.4/highlight.min.js"></script>
    <script>
        hljs.initHighlightingOnLoad();
    </script>
    <script src="//cdn.bootcss.com/jquery/1.11.2/jquery.min.js"></script>
    <script src="//cdn.bootcss.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>

</body>

</html>